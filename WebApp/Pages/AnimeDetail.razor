@page "/AnimeDetail/{AnimeID:int}"
@page "/AnimeDetail/{AnimeID:int}/Episodio/{NumeroEpisodio:int}"

@inject IJSRuntime JS
@inject HttpClient client
@inject NavigationManager navigationManager
@inject Generic generic
@inject SpinnerService spinner

@using Commons;
@using Commons.Enums;
@using System.Text.Json;
@using System.Text.Json.Serialization;

@code {
    [Parameter] public int AnimeID { get; set; }
    [Parameter] public int? NumeroEpisodio { get; set; } = -1;

    private VideoPlayer vp = new VideoPlayer();

    Anime anime = new Anime();
    Anime prequel = new Anime();
    Anime sequel = new Anime();
    AnimeEpisodi listEpisodi = new AnimeEpisodi();

    protected override void OnParametersSet()
    {
        if (NumeroEpisodio != null && NumeroEpisodio.HasValue)
        {
            vp.VideoNumeroEpisodio = NumeroEpisodio;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        spinner.Show();
        //await Task.Delay(5000);

        APIResponse ApiResponse = new APIResponse();

        try
        {
            //    //ApiResponse = await client.GetFromJsonAsync<APIResponse>("/api/v1/anime/" + AnimeID, jso);
            //    ApiResponse = await client.GetFromJsonAsync<APIResponse>("/api/v1/anime/MockUpResponse");
            //    ApiResponse = generic.GetSingleRequest<APIResponse>("/api/v1/anime/MockUpResponse");
            ApiResponse = GetAnime();
            anime = (Anime)ApiResponse.Data;

        if (ApiResponse.StatusCode != System.Net.HttpStatusCode.OK)
        {
            navigationManager.NavigateTo("/");
            return;
        }

        anime = JsonSerializer.Deserialize<Anime>(ApiResponse.Data.ToString());


        if (anime.Prequel != null && anime.Prequel.HasValue)
        {
            ApiResponse = null;
            //ApiResponse = await client.GetFromJsonAsync<APIResponse>("/api/v1/anime/" + anime.Prequel);
            ApiResponse = await client.GetFromJsonAsync<APIResponse>("/api/v1/anime/MockUpResponse");
            if (ApiResponse.StatusCode == System.Net.HttpStatusCode.OK)
                prequel = (Anime)ApiResponse.Data;
        }

        if (anime.Sequel != null && anime.Sequel.HasValue)
        {
            ApiResponse = null;
            //ApiResponse = await client.GetFromJsonAsync<APIResponse>("/api/v1/anime/" + anime.Sequel);
            ApiResponse = await client.GetFromJsonAsync<APIResponse>("/api/v1/anime/MockUpResponse");
            if (ApiResponse.StatusCode == System.Net.HttpStatusCode.OK)
                sequel = (Anime)ApiResponse.Data;
        }

        try
        {
            //////TODO - Estrarre Episodi Anime
            ////listEpisodi = await client.GetFromJsonAsync<AnimeEpisodi>("/api/v1/episodi/" + AnimeID);
            listEpisodi = GetAnimeEpisodi();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Generic Exception Catch: {ex.Message}");
            navigationManager.NavigateTo("/");
            return;
        }



        spinner.Hide();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        vp.VideoNumeroEpisodioChanged += ChildFiredEvent;
    }

    public void ChildFiredEvent(int _numEpisodio)
    {
        NumeroEpisodio = _numEpisodio;
        StateHasChanged();
    }

    private APIResponse GetAnime()
    {
        Anime animeMK = new Anime();
        animeMK.Format = AnimeFormatEnum.TV;
        animeMK.EpisodesCount = 35;
        animeMK.EpisodeDuration = 23;
        animeMK.Status = AnimeStatusEnum.FINISHED;
        animeMK.StartDate = DateTime.Now;
        animeMK.SeasonPeriod = AnimeSeasonEnum.SUMMER;
        animeMK.SeasonYear = 2018;
        animeMK.Score = 79;
        animeMK.Genres = new List<string>() { "Action", "Drama", "Fantasy", "Mystery", "che ne so!!" };
        animeMK.CoverImage = "https://s4.anilist.co/file/anilistcdn/media/anime/cover/medium/bx104578-LaZYFkmhinfB.jpg";
        animeMK.BannerImage = "https://s4.anilist.co/file/anilistcdn/media/anime/banner/104578-z7SadpYEuAsy.jpg";
        animeMK.Sequel = 2;
        animeMK.Prequel = 2;
        animeMK.TrailerUrl = "https://www.animeunityserver75.cloud/DDL/Anime/OnePieceITA/OnePiece_Ep_001_ITA.mp4";


        animeMK.Titles = new Dictionary<string, string>();
        animeMK.Titles.Add(LocalizationEnum.English, "Shingeki no Kyojin 3 Part 2");

        animeMK.Descriptions = new Dictionary<string, string>();
        animeMK.Descriptions.Add(LocalizationEnum.English, "The second cour of <i>Shingeki no Kyojin 3</i>.<br><br>The battle to retake Wall Maria begins now! With Eren’s new hardening ability, the Scouts are confident they can seal the wall and take back Shiganshina District. If they succeed, Eren can finally unlock the secrets of the basement—and the world. But danger lies in wait as Reiner, Bertholdt, and the Beast Titan have plans of their own. Could this be humanity’s final battle for survival?<br><br>(Source: Funimation)");


        APIResponse response = new APIResponse();

        response.StatusCode = System.Net.HttpStatusCode.OK;
        response.Message = null;
        response.Data = animeMK;
        response.Version = "1.0.1.0";

        return response;
    }

    private AnimeEpisodi GetAnimeEpisodi()
    {
        AnimeEpisodi listEp = new AnimeEpisodi();
        listEp.Episodi = new List<Episodio>();
        @for (int i = 1; i <= anime.EpisodesCount; i++)
        {
            string fmt = "000";
            string urlEp = $"https://www.animeunityserver75.cloud/DDL/Anime/OnePieceITA/OnePiece_Ep_{i.ToString(fmt)}_ITA.mp4";
            Episodio ep = new Episodio() { NumeroEpisodio = i, Url = urlEp, Sorgente = "animeunity" };
            listEp.Episodi.Add(ep);
        }

        return listEp;
    }
}

@*@if (anime == null)
{
    <p><em>Loading...</em></p>
}
else
{*@
    <div class="content">
        <div class="section no-p">
            <div class="banner" style=" background-image: url(@anime.BannerImage);"></div>
        </div>
        <div class="section no-p">
            <div class="container">
                <div class="heading">
                    <div class="cover" style=" background-image: url(@anime.CoverImage);"></div>
                    <div class="head">
                        <h1 class="title">@(anime.Titles != null ? anime.Titles[LocalizationEnum.English] : "No Title")</h1>
                        <p class="desc">
                            @((MarkupString)(anime.Descriptions != null ? anime.Descriptions[LocalizationEnum.English] : "No Description"))
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <div class="section main">
            <div class="container">
                <div class="siblings">
                    @if (anime.Prequel != null && anime.Prequel.HasValue)
                    {
                        <div class="sibling prequel" style="background-image: url(@prequel.BannerImage);">
                            <span>Prequel</span>
                            <h3 class="title">@prequel.Titles[LocalizationEnum.English]</h3>
                        </div>
                    }

                    @if (anime.Sequel != null && anime.Sequel.HasValue)
                    {
                        <div class="sibling sequel" style="background-image: url(@sequel.BannerImage);">
                            <span>Sequel</span>
                            <h3 class="title">@sequel.Titles[LocalizationEnum.English]</h3>
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="section dock">
            <div class="container">
                <div class="info">
                    <div class="row">
                        <span>Format</span>@anime.Format
                    </div>
                    <div class="row">
                        <span>Episodes</span>@anime.EpisodesCount
                    </div>
                    @if (anime.EpisodeDuration != null && anime.EpisodeDuration.HasValue)
                    {
                        <div class="row">
                            <span>Episode Duration</span>@anime.EpisodeDuration.Value minutes
                        </div>
                    }
                    <div class="row">
                        <span>Status</span>@anime.Status
                    </div>
                    @if (anime.StartDate != null && anime.StartDate.HasValue)
                    {
                        <div class="row">
                            <span>Start Date</span>@anime.StartDate.Value.ToString("MMM dd, yyyy")
                        </div>
                    }
                    @if (anime.EndDate != null && anime.EndDate.HasValue)
                    {
                        <div class="row">
                            <span>End Date</span>@anime.EndDate.Value.ToString("MMM dd, yyyy")
                        </div>
                    }
                    <div class="row">
                        <span>Season</span>@anime.SeasonPeriod @(anime.SeasonYear!= null && anime.SeasonYear.HasValue ? anime.SeasonYear.Value.ToString() : "")
                    </div>
                    <div class="row">
                        <span>Score</span> @anime.Score %
                    </div>
                    @if (anime.Genres != null)
                    {
                        <div class="row">
                            <span>Genres</span>@String.Join(", ", anime.Genres.OrderBy(g => g))
                        </div>
                    }
                </div>
                <div class="media">
                    <div class="VideoTitle">
                        @(NumeroEpisodio != null && NumeroEpisodio.HasValue ? ("Episodio: " + NumeroEpisodio.Value.ToString()) : "Trailer")
                    </div>
                    @if(listEpisodi.Episodi != null)
                    {
                        <VideoPlayer @ref="vp" listEpisodi="@listEpisodi" @bind-VideoNumeroEpisodio="@NumeroEpisodio" />
                    }
                    <div class="episodes">
                        @for (int i = 1; i <= anime.EpisodesCount; i++)
                        {
                            <a href="/AnimeDetail/@AnimeID/Episodio/@i"><div class="episode @(NumeroEpisodio!= null && NumeroEpisodio.HasValue && NumeroEpisodio.Value == i ? "active" : "" )">@i</div></a>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

@*}*@